---
- name: Gather variables for each operating system
  ansible.builtin.include_vars: "{{ ansible_os_family }}-family.yml"

- name: Include distribution specific install tasks
  ansible.builtin.include_tasks: "install-{{ ansible_os_family }}-family.yml"

- name: Copy CA certificates
  become: true
  ansible.builtin.template:
    src: certificates.j2
    dest: "{{ certificates_ca_path }}/{{ item.name }}"
    owner: root
    group: root
    mode: 0644
  loop: "{{ certificates_ca }}"
  notify: Update CA certificates

- name: Check if configuration directory CA certificates path exists
  ansible.builtin.stat:
    path: "{{ certificates_configuration_directory }}/certificates/ca"
  register: certificates_ca_directory_stat
  delegate_to: "{{ groups[certificates_manager_group][0] }}"
  run_once: true

- name: Find .crt files in configuration directory
  ansible.builtin.find:
    paths: "{{ certificates_configuration_directory }}/certificates/ca"
    patterns: "*.crt"
    file_type: file
  register: certificates_ca_files
  delegate_to: "{{ groups[certificates_manager_group][0] }}"
  run_once: true
  when:
    - certificates_ca_directory_stat.stat.exists
    - certificates_ca_directory_stat.stat.isdir

- name: Read CA certificate content from manager
  ansible.builtin.slurp:
    src: "{{ item.path }}"
  register: certificates_ca_content
  delegate_to: "{{ groups[certificates_manager_group][0] }}"
  loop: "{{ certificates_ca_files.files }}"
  when:
    - certificates_ca_directory_stat.stat.exists
    - certificates_ca_directory_stat.stat.isdir
    - certificates_ca_files.files | length > 0

- name: Copy CA certificates from configuration directory to all nodes
  become: true
  ansible.builtin.copy:
    content: "{{ item.content | b64decode }}"
    dest: "{{ certificates_ca_path }}/{{ item.item.path | basename }}"
    owner: root
    group: root
    mode: 0644
  loop: "{{ certificates_ca_content.results }}"
  when:
    - certificates_ca_directory_stat.stat.exists
    - certificates_ca_directory_stat.stat.isdir
    - certificates_ca_files.files | length > 0
    - not item.skipped | default(false)
  notify: Update CA certificates
